
<!DOCTYPE HTML>
<html lang="en">

<head>
<meta charset="utf-8">
<!-- <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="author" content="Olivier Barais">
<link rel="author" href="https://plus.google.com/+OlivierBarais">

<title>Using Go-Docker and Docker Swarm to create a  high-volume live and on demand video encoding solutions</title>



<!-- Add custom CSS here -->
<!-- <link rel="stylesheet" href="/assets/main-58abab6103ee78e02cfcfa062233325f.css"> -->

<!-- <link rel="shortcut icon" href="favicon.ico"> -->
<link rel="icon" href="favicon.ico">


<!-- Test -->

</head>

<body>

    	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
					<span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
				</button>
                <a class="navbar-brand" href="/">olivier.barais</a>
			</div>

			<!-- Collect the nav links, forms, and other content for toggling -->
			<div class="collapse navbar-collapse navbar-right navbar-ex1-collapse">
				<ul class="nav navbar-nav">
                    <li><a href="/">Home</a></li>
					<li><a href="/publications/">Publications</a></li>
					<li><a href="/teaching/">Teaching</a></li>
                    <li><a href="/research/">Research</a></li>
                    <li><a href="/blog/">Blog</a></li>
                    <li><a href="/photos/">Photos</a></li>
                    <li><a href="/contact/">Contact</a></li>
				</ul>
			</div>
			<!-- /.navbar-collapse -->
		</div>
		<!-- /.container -->
	</nav>


    <div class="container">
        <div class="row">
            <div class="col-md-8">
                               <!-- the actual blog post: title/author/date/content -->
                <h1> Using Go-Docker and Docker Swarm to create a  high-volume live and on demand video encoding solutions </h1>
                    <p class="lead">by <a href="/contact/">Olivier Barais</a> &nbsp;&nbsp;&nbsp;
                        
                            <a href="/blog/categories/docker/"><span class="label label-primary">docker</span></a>
                            &nbsp;
                        
                            <a href="/blog/categories/swarm/"><span class="label label-primary">swarm</span></a>
                            &nbsp;
                        
                            <a href="/blog/categories/go-docker/"><span class="label label-primary">go-docker</span></a>
                            &nbsp;
                        
                    </p>
                        <span class="glyphicon glyphicon-time"></span> Posted 2015.12.01 
                        
                            &mdash; Rennes, France
                        

                <hr>
                
                <p>The idea is to propose an initial solution to securely manages high-volume live and on demand video encoding solutions in
combination with the scale and elasticity of the cloud. The providing service will automatically provisions and dynamically scales docker instances, and can seamlessly integrate those resources with on site infrastructure to instantly expand video processing capacity. This flexibility enables video providers to rapidly enhance multiscreen video offerings, grow audiences, generate greater revenues, and decrease capital expenses.</p>

<!--more-->

<p>In this example, we will build an initial proof of concept for video encoding using <a href="http://www.genouest.org/godocker/">go-docker</a>, <a href="https://docs.docker.com/swarm/">docker swarm</a>, <a href="https://github.com/google/cadvisor">cAdvisor</a>, <a href="http://grafana.org/">grafana</a> and <a href="https://influxdb.com/">influxDB</a>. </p>

<h1>Step 1: Docker swarm installation</h1>

<p>You can follow this tutorial
<a href="https://docs.docker.com/swarm/install-manual/">docker swarm installation</a></p>

<p>To summary</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">docker pull swarm
docker run --rm swarm create
&gt; 7c99516aee4662826684dde48f60361f
#get the id. Replace in the next commands
</code></pre></div>
<p>Next join the swarm (replace the token in the following commands):</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">docker run -d swarm join --addr=172.17.0.1:2375 token://7c99516aee4662826684dde48f60361f
</code></pre></div>
<p>Finally launch the manager</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">docker run -d -p 2378:2375 swarm manage token://7c99516aee4662826684dde48f60361f
</code></pre></div>
<p>check it works. </p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">docker -H tcp://localhost:2378 info
</code></pre></div>
<p>You should get something like that</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">78 info
Containers: 104
Images: 37
Role: primary
Strategy: spread
Filters: health, port, dependency, affinity, constraint
Nodes: 1
 head-demo: 172.17.0.1:2375
  └ Containers: 104
  └ Reserved CPUs: 4 / 4
  └ Reserved Memory: 4 GiB / 16.35 GiB
  └ Labels: executiondriver=native-0.2, kernelversion=4.2.0-18-generic, operatingsystem=Ubuntu 15.10, storagedriver=overlay
CPUs: 4
Total Memory: 16.35 GiB
Name: 0a478e14e47e
</code></pre></div>
<h1>Step 2 Install go-docker</h1>

<h2>Requirements</h2>

<p>Mongodb and Redis are required. Either install them on a server, or get them in containers:</p>

<p>Run god-mongo god-redis. </p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">docker rm god-mongo god-redis god-web
docker -H localhost:2378  run --name god-mongo -d mongo
docker -H localhost:2378  run --name god-redis -d redis
</code></pre></div>
<h2>Running components</h2>

<p>Run the web server, interface is reachable at http://localhost:6543</p>

<p>Get the following config file</p>

<ul>
<li><a href="../../../docs/godocker/go-d.ini">go-d.ini</a></li>
<li><a href="../../../docs/godocker/production.ini">production.ini</a></li>
</ul>

<p>Warning: data shared directory (here /opt/godshared) must match
on host AND container as final job will end in a host container needing the same volume directory.
shared_dir parameter in go-d.ini configuration file must be changed accordingly.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir /opt/godshared
mkdir /tmp/vid
</code></pre></div><div class="highlight"><pre><code class="language-bash" data-lang="bash">docker -H localhost:2378  run \
  --rm \
  --name god-web
  --link god-mongo:god-mongo  \
  --link god-redis:god-redis  \
  -v /opt/godshared:/opt/godshared \
  -v path_to/go-d.ini:/opt/go-docker/go-d.ini \
  -v path_to/production.ini:/opt/go-docker-web/production.ini \
  -p 6543:6543 \
  -e &quot;PYRAMID_ENV=prod&quot; \
  osallou/go-docker \
  gunicorn -p godweb.pid --log-config=/opt/go-docker-web/production.ini --paste /opt/go-docker-web/production.ini
</code></pre></div>
<p>The first time only, you must initialize db etc...</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">docker -H localhost:2378 run \
--link god-mongo:god-mongo \
--link god-redis:god-redis \
-v /opt/godshared:/opt/godshared \
-v path_to/go-d.ini:/opt/go-docker/go-d.ini \
 --rm \
 osallou/go-docker \
 /usr/bin/python go-d-scheduler.py init
</code></pre></div>
<p>Run one scheduler</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">docker -H  localhost:2378 run \
  --rm \
  --link god-mongo:god-mongo  \
  --link god-redis:god-redis  \
  --link god-web:god-web \
  -v /opt/godshared:/opt/godshared \
  -v path_to/go-d.ini:/opt/go-docker/go-d.ini \
  osallou/go-docker \
  /usr/bin/python go-d-scheduler.py run
</code></pre></div>
<p>Run one or many watchers (1 is enough test or medium size production)</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">docker -H localhost:2378  run \
  --rm \
  --link god-mongo:god-mongo  \
  --link god-redis:god-redis  \
  --link god-web:god-web \
  -v /opt/godshared:/opt/godshared \
  -v path_to/go-d.ini:/opt/go-docker/go-d.ini \
  osallou/go-docker \
  /usr/bin/python go-d-watcher.py run
</code></pre></div>
<h1>Step 3 Create and schedule tasks</h1>

<p>Install godocker cli.
<code>bash
pip install godocker_cli
</code></p>

<p>Configure your go-docker</p>

<p>Go to http://localhost:6543/
In the project, create a project test and add godocker as a member and add a share folder /tmp/vid video volume. </p>

<p><a href="../../../docs/godocker/image.png"><img src="../../../docs/godocker/image.png"  width="750" /></a></p>

<p>Next go to the godocker (top right) link. 
and get the APIKEY</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">~/.local/bin/godlogin -a &lt;APIKEY&gt; -l godocker -s http://localhost:6543/ --no-certificate
</code></pre></div><div class="highlight"><pre><code class="language-bash" data-lang="bash">cd /tmp/vid
mkdir /tmp
wget http://arcagenis.org/mirror/mango/ToS/tears_of_steel_1080p.mkv
</code></pre></div>
<p>Next download the two following scripts</p>

<ul>
<li><a href="../../../docs/godocker/split.sh">split.sh</a></li>
<li><a href="../../../docs/godocker/mergeandclean.sh">mergeandclean.sh</a></li>
</ul>

<p>Run the followind three command</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">SPLIT=`~/.local/bin/godjob create  --external_image    -n split -d &quot;Jit Split&quot;   -p test -i barais/ffmpeg -s split.sh | sed -r &#39;s/Task added. Job id is //g&#39;`


for f in /tmp/vid/tmp/*.sh; do echo &quot;`~/.local/bin/godjob create  --external_image    -n encode -d &quot;Jit Encode&quot; -c 1 --parent &quot;$SPLIT&quot;  -p test -i barais/ffmpeg -s $f | sed -r &#39;s/Task added. Job id is //g&#39;`,&quot; &gt;&gt; /tmp/vid/tmp/listprocess  ; done &amp;&amp; PROCESS=`cat  /tmp/vid/tmp/listprocess | tr -d &#39;\n&#39;`


~/.local/bin/godjob create  --external_image    -n merge -d &quot;Jit Merge and Clean&quot;  -c 1 --parent &quot;${PROCESS-1}&quot; -p test -i barais/ffmpeg -s mergeandclean.sh

</code></pre></div>
<p>You can also run everythin in one command</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir /tmp/vid/tmp &amp;&amp; SPLIT=`~/.local/bin/godjob create  --external_image    -n split -d &quot;Jit Split&quot;   -p test -i barais/ffmpeg -s split.sh | sed -r &#39;s/Task added. Job id is //g&#39;` &amp;&amp; for f in /tmp/vid/tmp/*.sh; do echo &quot;`~/.local/bin/godjob create  --external_image    -n encode -d &quot;Jit Encode&quot; -c 1 --parent &quot;$SPLIT&quot;  -p test -i barais/ffmpeg -s $f | sed -r &#39;s/Task added. Job id is //g&#39;`,&quot; &gt;&gt; /tmp/vid/tmp/listprocess  ; done &amp;&amp; PROCESS=`cat  /tmp/vid/tmp/listprocess | tr -d &#39;\n&#39;` ~/.local/bin/godjob create  --external_image    -n merge -d &quot;Jit Merge and Clean&quot;  -c 1 --parent &quot;${PROCESS-1}&quot; -p test -i barais/ffmpeg -s mergeandclean.sh
</code></pre></div>
<p>Next you can easily install cAdvisor and grafana. Just modify to go-d.ini file. </p>

<h1>Next steps</h1>

<h2>Technical details</h2>

<ul>
<li>Use go-docker env variables to encode in a task specific folder. </li>
<li>Use <a href="http://www.gluster.org/">glusterfs</a> to share volumes and compare the performance with the use of a simple nfs filse system. Does it matter for such a use case. </li>
<li>Decrease docker ffmpeg image size.</li>
<li>Finish a small portable demonstrator based on four raspberry pis 2 (within this <a href="http://www.ldlc.com/fiche/PB00168033.html">box</a>).<br></li>
<li>Do the same experience with <a href="https://tools.taskcluster.net/">mozilla taskcluster</a> to compare with go-docker. </li>
</ul>

<h2>Scientific Breakthroughs</h2>

<ul>
<li>Allow to share hardware capabilities such as GPU encoding facilities with go-docker. </li>
<li>Define a standard librairies of video processing micro-services. </li>
<li>Provide dataflow tempate to let user specify video processing flows. (We will use <a href="http://nodered.org/">node-red</a> to test). </li>
<li>Provide an extenstible framework for creating and testing video processing micro-services that can be easily included in a video-processing flows. </li>
<li>Improve or specialize docker scheduler such as swarm, <a href="https://hashicorp.com/blog/nomad.html">nomad</a> or <a href="http://mesos.apache.org/">mesos</a> to put video processing micro-services close to video raw datas. </li>
<li>Use the best hardware storage technologies depending of the micro-services wich is used.</li>
</ul>

<h2>Want to play with us</h2>

<ul>
<li>Join <a href="https://b-com.com/">B-COM</a> JiT project. <a href="mailto:Christophe.DION@b-com.com;Antoine.CABOT@b-com.com;barais@irisa.fr">contact</a></li>
</ul>

<p>Have fun ...</p>

                
                <!-- the comment box -->
<!--                 <div class="well">
                    <h4>Leave a Comment:</h4>
                    <form role="form">
                        <div class="form-group">
                            <textarea class="form-control" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </div> -->

                <!-- the comments -->
<!--                 <hr>
 --><!--                 <h3>Start Bootstrap
                    <small>9:41 PM on August 24, 2013</small>
                </h3>
                <p>This has to be the worst blog post I have ever read. It simply makes no sense. You start off by talking about space or something, then you randomly start babbling about cupcakes, and you end off with random fish names.</p>

                <h3>Start Bootstrap
                    <small>9:47 PM on August 24, 2013</small>
                </h3>
                <p>Don't listen to this guy, any blog with the categories 'dinosaurs, spaceships, fried foods, wild animals, alien abductions, business casual, robots, and fireworks' has true potential.</p> -->

<!--             <div class="row"> -->
<!--                 % include well.html %} -->
<!--             </div> -->

<!--             </div> -->
<!--             % include well.html %} -->
            

            </div>
            <div class="col-md-4">
                <!-- <div class="col-md-4"> -->
    <!--              
    <div class="well">
        <h4>Blog Search</h4>
        <div class="input-group">
            <input type="text" class="form-control">
            <span class="input-group-btn">
                <button class="btn btn-default" type="button">
                    <span class="glyphicon glyphicon-search"></span>
                </button>
            </span>
        </div>
    </div>
    -->

    

    <div class="well">
        <div class="row">
            <div class="col-md-6">
                <h4>Current Tags</h4>
                <ul class="list-unstyled">
                    
                    <li><a href="/blog/categories/docker/">docker</a></li> 
                    <li><a href="/blog/categories/swarm/">swarm</a></li> 
                    <li><a href="/blog/categories/go-docker/">go-docker</a></li> 
                </ul>
            </div>
        </div>
    </div>

    

    <div class="well">
        <div class="row">
            <div class="col-lg-6">
                <h4>All Tags</h4>
                <ul class="list-unstyled">
                    <li><a href="/blog/">All</a></li> 
                    <li><a href="/blog/categories/first-post/">first-post</a></li> 
                    <li><a href="/blog/categories/jekyll/">jekyll</a></li> 
                    <li><a href="/blog/categories/github-pages/">github-pages</a></li> 
                    <li><a href="/blog/categories/markdown/">markdown</a></li> 
                    <li><a href="/blog/categories/untidy/">untidy</a></li> 
                    <li><a href="/blog/categories/teaching/">teaching</a></li> 
                    <li><a href="/blog/categories/website/">website</a></li> 
                    <li><a href="/blog/categories/docker/">docker</a></li> 
                    <li><a href="/blog/categories/cloud/">cloud</a></li> 
                    <li><a href="/blog/categories/diversify/">diversify</a></li> 
                    <li><a href="/blog/categories/eclipse/">eclipse</a></li> 
                    <li><a href="/blog/categories/istic/">istic</a></li> 
                    <li><a href="/blog/categories/m2/">m2</a></li> 
                    <li><a href="/blog/categories/french/">french</a></li> 
                    <li><a href="/blog/categories/ensai/">ensai</a></li> 
                    <li><a href="/blog/categories/kevoree/">kevoree</a></li> 
                    <li><a href="/blog/categories/kevoreejs/">kevoreejs</a></li> 
                    <li><a href="/blog/categories/edison/">edison</a></li> 
                    <li><a href="/blog/categories/angularjs/">angularjs</a></li> 
                    <li><a href="/blog/categories/jquery/">jquery</a></li> 
                    <li><a href="/blog/categories/jhipster/">jhipster</a></li> 
                    <li><a href="/blog/categories/sdn/">sdn</a></li> 
                    <li><a href="/blog/categories/opendaylight/">opendaylight</a></li> 
                    <li><a href="/blog/categories/software engineering/">software engineering</a></li> 
                    <li><a href="/blog/categories/ejcp/">ejcp</a></li> 
                    <li><a href="/blog/categories/swarm/">swarm</a></li> 
                    <li><a href="/blog/categories/go-docker/">go-docker</a></li> 
                    <li><a href="/blog/categories/raspberry pi/">raspberry pi</a></li> 
                    <li><a href="/blog/categories/javascript/">javascript</a></li> 
                    <li><a href="/blog/categories/java/">java</a></li> 
                    <li><a href="/blog/categories/slides/">slides</a></li> 
                    <li><a href="/blog/categories/reveal.js/">reveal.js</a></li> 
                    <li><a href="/blog/categories/powerpoint/">powerpoint</a></li> 
                    <li><a href="/blog/categories/migration/">migration</a></li> 
                    <li><a href="/blog/categories/labfab/">labfab</a></li> 
                    <li><a href="/blog/categories/api-platform/">api-platform</a></li> 
                    <li><a href="/blog/categories/symfony3/">symfony3</a></li> 
                    <li><a href="/blog/categories/ng2/">ng2</a></li> 
                    <li><a href="/blog/categories/angularjs2/">angularjs2</a></li> 
                    <li><a href="/blog/categories/rpi/">rpi</a></li> 
                    <li><a href="/blog/categories/raspberrypi/">raspberrypi</a></li> 
                    <li><a href="/blog/categories/raspberry/">raspberry</a></li> 
                </ul>
            </div>
        </div>
    </div>

    <div class="well">
        <h4>Remark</h4>
        <p>Sorry, no comments enabled for now because I'm using a simple static site generator (maybe I'll try out disqus another day).</p>
        <p>
            But if you like what you see, send me an <a href="/contact/">email</a>.
        </p>
    </div>
<!-- </div> -->

            </div>
        </div>
    </div>

    <hr>

    <div class="banner">
    <div class="container">
        <div class="row">
            <div class="col-lg-3">
                <!--                     <h2>You can check me out on</h2> -->
                <h2>Find me on</h2>
            </div>
            <div class="col-lg-9">
                <ul class="list-inline banner-social-buttons">
                    <li><a href="http://www.linkedin.com/in/olivierbarais" class="btn btn-default btn-lg"><i class="fa fa-linkedin-square fa-fw"></i>
                            <span class="network-name">Linkedin</span></a></li>
                    <li><a href="https://github.com/barais" class="btn btn-default btn-lg"><i class="fa fa-github-square fa-fw"></i> <span
                            class="network-name">Github</span></a></li>
                    <li><a href="http://scholar.google.fr/citations?user=LV5i8X4AAAAJ&hl=en" class="btn btn-default btn-lg"><i
                            class="fa fa-search fa-fw"></i> <span class="network-name">Scholar</span></a></li>
                    <li><a href="https://www.google.com/+OlivierBarais?rel=author" class="btn btn-default btn-lg"><i
                            class="fa fa-google-plus-square fa-fw"></i> <span class="network-name">google+</span></a></li>
                    <li><a href="https://www.facebook.com/obarais" class="btn btn-default btn-lg"><i
                            class="fa fa-facebook-square fa-fw"></i> <span class="network-name">facebook</span></a></li>
                </ul>
            </div>
        </div>
    </div>
    <!-- /.container -->

</div>
<!-- /.banner -->

<footer>
    <div class="container">
        <div class="span12 pagination-centered" style="text-align: center">
            <div class="row">
                <div class="col-lg-12">
                    <ul class="list-inline">
                        <li><a href="/">Home</a></li>
                        <li class="footer-menu-divider">&sdot;</li>
                        <!-- 						<li><a href="#about">About</a></li>
							<li class="footer-menu-divider">&sdot;</li>
	                    -->
                        <li><a href="/publications/">Publications</a></li>
                        <li class="footer-menu-divider">&sdot;</li>
                        <li><a href="/teaching/">Teaching</a></li>
                        <li class="footer-menu-divider">&sdot;</li>
                        <li><a href="/research/">Research</a></li>
                        <li class="footer-menu-divider">&sdot;</li>
                        <li><a href="/blog/">Blog</a></li>
                        <li class="footer-menu-divider">&sdot;</li>
                        <li><a href="/photos/">Photos</a></li>
                        <li class="footer-menu-divider">&sdot;</li>
                        <li><a href="/contact/">Contact</a></li>
                    </ul>

                    <p class="copyright text-muted small">
                        <a href="http://validator.w3.org/check?uri=referer"><img src="/img/valid-html401.png"
                            alt="Valid HTML 4.01 Frameset" height="20" width="57"></a> Built using <a href="http://jekyllrb.com/">Jekyll</a>, <a
                            href="http://twitter.github.com/bootstrap/">Bootstrap</a> and <a href="http://startbootstrap.com">Startbootstrap</a> from <a href="http://rudametw.github.io/">Walter Rudametkin's template</a>. All
                        source code available <a href="https://github.com/barais/barais.github.io"> here</a>. 
                    </p>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- Defer CSS -->
    <script type="text/javascript">
          var stylesheet = document.createElement('link');
          stylesheet.href = '/assets/main-58abab6103ee78e02cfcfa062233325f.css';
          stylesheet.rel = 'stylesheet';
          stylesheet.type = 'text/css';
          document.getElementsByTagName('head')[0].appendChild(stylesheet);
    </script>

<!-- Add custom CSS here -->
<!-- <link rel="stylesheet" href="/assets/main-58abab6103ee78e02cfcfa062233325f.css"> -->

<!-- Main Javascript -->
<!-- <script src="/assets/main-f2bda5f0801b6a41743c383e9ab4635a.js"></script> -->
<script async type="text/javascript" src="/assets/main-f2bda5f0801b6a41743c383e9ab4635a.js"></script>

<!-- <script> -->
<!-- loadStyleSheet(/assets/main-58abab6103ee78e02cfcfa062233325f.css); -->
<!-- </script> -->

<!--<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48705379-1', 'rudametw.github.io');
  ga('send', 'pageview');
</script>-->


</body>
</html>